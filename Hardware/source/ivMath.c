/******************************************************************************
* File Name		       : ivMath.c
* Description          : InterSound 算术运算源文件
* Author               : pingbu
* Date Of Creation     : 2005-06-24
* Platform             : Any
* Modification History : 
*------------------------------------------------------------------------------
* Date        Author     Modifications
*------------------------------------------------------------------------------
* 2005-06-24  pingbu     Created
******************************************************************************/

#include "ivMath.h"
#include "EsFrontConst.h"

/* 求双精度浮点值的归1化因子 */
ivUInt16 ivCall es_norm_l(Q31 ivInt32 L_var1) /* 与硕呈平台AitalkMini1.0代码相同 */
{
	ivUInt16 var_out;

	if ( 0 == L_var1 )
		return 0;

	if ( -1 == L_var1 )
		return 31;

	if ( L_var1 < 0 )
		L_var1 = ~L_var1;

	for ( var_out = 0; L_var1 < DOUBLE_Q30; ++ var_out )
		L_var1 <<= 1;

	return var_out;
}

/* input format (32 - Q).Q, output Q10, 返回值范围在[0, 22719]*/
ivInt16 ivCall simple_table_ln(ivUInt32 w32Param, ivInt16 cParamQ) /* 与硕呈平台AitalkMini1.0代码相同 */
{	
	ivInt16 s16Result;
	ivInt16 s16Lable;
	ivInt16 s16Q = cParamQ;

	w32Param |= 1;

	if (!(w32Param & 0xFFFF0000))
	{
		/* All of first 16 bits are zero */
		w32Param <<= 16;
		s16Q += 16;
	}
	if (!(w32Param & 0xFF000000))
	{
		/* All of first 8 bits are zero */
		w32Param <<= 8;
		s16Q += 8;
	}
	if (!(w32Param & 0xF0000000))
	{
		/* All of first 4 bits are zero */
		w32Param <<= 4;
		s16Q += 4;
	}
	if (!(w32Param & 0xC0000000))
	{
		/* All of first 2 bits are zero */
		w32Param <<= 2;
		s16Q += 2;
	}
	if (!(w32Param & 0x80000000))
	{
		/* All of first 1 bits are zero */
		w32Param <<= 1;
		s16Q += 1;
	}
	w32Param = w32Param - 0x80000000L;
	s16Lable = (ivInt16)(w32Param>>22); /* 9bit */

	/* g_s16SimpleLnTable[s16Lable]:Q16,[1-2)的ln值,其中(1+s16Label*1.0/(1<<9))->[1-2) */
	s16Result = (ivInt16)(((ivInt32)(g_s16SimpleLnTable[s16Lable]) + (ivInt32)((31-s16Q)*0xB172L))>>6); /* LN2 Q16 = 0XB172L */

	return s16Result;
}

void ivCall ivMakeCRC(ivPCInt16 pData,ivUInt32 nSize,ivPUInt32 pnCRC,ivPUInt32 piCounter) /* 与硕呈平台AitalkMini1.0代码相同 */
{
	ivUInt32 i;
	for(i=0;i<(nSize>>1);i++,++*piCounter){
		*pnCRC += (pData[i]*(1+*piCounter)) << ((*piCounter)&0xf);
		*pnCRC += pData[i];
	}
}

#if ESR_CPECTRAL_SUB
/* Q14,求解sqrt(x).其中x范围为[0.5,1),表是10bit的 */
ivConst ivInt16 g_s16Table_sqrt_10Bit[513] = {
    11585,11597,11608,11619,11630,11642,11653,11664,11675,11687,11698,11709,11720,11731,11743,11754,
    11765,11776,11787,11798,11809,11820,11832,11843,11854,11865,11876,11887,11898,11909,11920,11931,
    11942,11953,11964,11975,11986,11997,12007,12018,12029,12040,12051,12062,12073,12084,12094,12105,
    12116,12127,12138,12149,12159,12170,12181,12192,12202,12213,12224,12235,12245,12256,12267,12277,
    12288,12299,12309,12320,12331,12341,12352,12362,12373,12384,12394,12405,12415,12426,12436,12447,
    12457,12468,12479,12489,12500,12510,12520,12531,12541,12552,12562,12573,12583,12594,12604,12614,
    12625,12635,12645,12656,12666,12677,12687,12697,12708,12718,12728,12738,12749,12759,12769,12780,
    12790,12800,12810,12820,12831,12841,12851,12861,12871,12882,12892,12902,12912,12922,12932,12943,
    12953,12963,12973,12983,12993,13003,13013,13023,13033,13043,13053,13064,13074,13084,13094,13104,
    13114,13124,13134,13144,13154,13163,13173,13183,13193,13203,13213,13223,13233,13243,13253,13263,
    13273,13282,13292,13302,13312,13322,13332,13342,13351,13361,13371,13381,13391,13400,13410,13420,
    13430,13439,13449,13459,13469,13478,13488,13498,13507,13517,13527,13537,13546,13556,13566,13575,
    13585,13595,13604,13614,13623,13633,13643,13652,13662,13671,13681,13691,13700,13710,13719,13729,
    13738,13748,13757,13767,13777,13786,13796,13805,13815,13824,13833,13843,13852,13862,13871,13881,
    13890,13900,13909,13918,13928,13937,13947,13956,13965,13975,13984,13994,14003,14012,14022,14031,
    14040,14050,14059,14068,14078,14087,14096,14106,14115,14124,14133,14143,14152,14161,14170,14180,
    14189,14198,14207,14217,14226,14235,14244,14253,14263,14272,14281,14290,14299,14309,14318,14327,
    14336,14345,14354,14363,14373,14382,14391,14400,14409,14418,14427,14436,14445,14454,14463,14472,
    14482,14491,14500,14509,14518,14527,14536,14545,14554,14563,14572,14581,14590,14599,14608,14617,
    14626,14635,14644,14653,14661,14670,14679,14688,14697,14706,14715,14724,14733,14742,14751,14759,
    14768,14777,14786,14795,14804,14813,14821,14830,14839,14848,14857,14866,14874,14883,14892,14901,
    14910,14918,14927,14936,14945,14954,14962,14971,14980,14989,14997,15006,15015,15024,15032,15041,
    15050,15058,15067,15076,15084,15093,15102,15111,15119,15128,15137,15145,15154,15162,15171,15180,
    15188,15197,15206,15214,15223,15231,15240,15249,15257,15266,15274,15283,15292,15300,15309,15317,
    15326,15334,15343,15351,15360,15369,15377,15386,15394,15403,15411,15420,15428,15437,15445,15454,
    15462,15471,15479,15487,15496,15504,15513,15521,15530,15538,15547,15555,15563,15572,15580,15589,
    15597,15606,15614,15622,15631,15639,15647,15656,15664,15673,15681,15689,15698,15706,15714,15723,
    15731,15739,15748,15756,15764,15773,15781,15789,15798,15806,15814,15822,15831,15839,15847,15855,
    15864,15872,15880,15889,15897,15905,15913,15921,15930,15938,15946,15954,15963,15971,15979,15987,
    15995,16004,16012,16020,16028,16036,16044,16053,16061,16069,16077,16085,16093,16102,16110,16118,
    16126,16134,16142,16150,16158,16167,16175,16183,16191,16199,16207,16215,16223,16231,16239,16247,
    16255,16264,16272,16280,16288,16296,16304,16312,16320,16328,16336,16344,16352,16360,16368,16376,
    16383
};

ivUInt16 CalSqrtRecip32(ivUInt32 s32Param)
{
    ivUInt16 s16Result;
    ivInt16 s16Lable;
    /* Left shift number */
    ivInt16 s16Q = 0;

#if 0
    double x = sqrt(s32Param);
#endif

    if(0 == s32Param){
        ++s32Param;
    }

    if (!(s32Param & 0xFFFF0000))
    {
        /* All of first 16 bits are zero */
        s32Param <<= 16;
        s16Q = 16;
    }
    if (!(s32Param & 0xFF000000))
    {
        /* All of first 8 bits are zero */
        s32Param <<= 8;
        s16Q += 8;
    }
    if (!(s32Param & 0xF0000000))
    {
        /* All of first 4 bits are zero */
        s32Param <<= 4;
        s16Q += 4;
    }
    if (!(s32Param & 0xC0000000))
    {
        /* All of first 2 bits are zero */
        s32Param <<= 2;
        s16Q += 2;
    }
    if (!(s32Param & 0x80000000))
    {
        /* All of first 1 bits are zero */
        s32Param <<= 1;
        s16Q += 1;
    }
    ivAssert(s16Q>1);

    //0x80000000,7FE00001
    s32Param -=  0x7FE00001; /* 因为查表的范围为[0.5,1),为了去除表中前面若干项无用的 */
    s16Lable = (ivInt16)(s32Param>>22);

    if (s16Q&1){
        s16Result = ((ivInt32)g_s16Table_sqrt_10Bit[s16Lable]*1448)>>(8+((s16Q+1)>>1));
    }
    else{
        s16Result = (((ivInt32)g_s16Table_sqrt_10Bit[s16Lable])<<2)>>(s16Q>>1);		
    }	
    //ivAssert(fabs(x-s16Result) <20);
    return s16Result;
}
#endif /* ESR_CPECTRAL_SUB */

